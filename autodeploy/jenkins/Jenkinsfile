// AutoDeployX Jenkins Pipeline
// CI/CD: Build ‚Üí Test ‚Üí Push ‚Üí Deploy to Minikube
// DockerHub: sarika1731/autodeployx

pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "sarika1731/autodeployx"
        BACKEND_URL = "http://backend:8000"
    }

    stages {
        stage('Pipeline Started') {
            steps {
                script {
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/status \
                            -H "Content-Type: application/json" \
                            -d '{"status": "running", "pipeline_name": "AutoDeployX", "build_number": ${BUILD_NUMBER}, "stage": "started", "message": "Pipeline #${BUILD_NUMBER} started"}' || true
                    """
                }
            }
        }

        stage('Checkout') {
            steps {
                script {
                    // Notify stage started
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/stage \
                            -H "Content-Type: application/json" \
                            -d '{"stage_name": "Checkout", "status": "running"}' || true
                    """
                }
                checkout scm
                script {
                    // Notify stage completed
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/stage \
                            -H "Content-Type: application/json" \
                            -d '{"stage_name": "Checkout", "status": "success"}' || true
                        
                        curl -X POST ${BACKEND_URL}/deployments/event \
                            -H "Content-Type: application/json" \
                            -d '{"event_type": "checkout", "status": "success", "details": {"branch": "${GIT_BRANCH}"}}' || true
                    """
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/stage \
                            -H "Content-Type: application/json" \
                            -d '{"stage_name": "Test", "status": "running"}' || true
                    """
                }
                dir('autodeploy/app') {
                    sh 'pip install -r requirements.txt || pip3 install -r requirements.txt'
                    sh 'python -m pytest ../tests/ -v || python3 -m pytest ../tests/ -v'
                }
                script {
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/stage \
                            -H "Content-Type: application/json" \
                            -d '{"stage_name": "Test", "status": "success"}' || true
                        
                        curl -X POST ${BACKEND_URL}/deployments/event \
                            -H "Content-Type: application/json" \
                            -d '{"event_type": "test", "status": "success", "details": {"tests_passed": true}}' || true
                    """
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/stage \
                            -H "Content-Type: application/json" \
                            -d '{"stage_name": "Build", "status": "running"}' || true
                    """
                }
                dir('autodeploy/docker') {
                    sh "docker build -t ${DOCKER_IMAGE}:${BUILD_NUMBER} -t ${DOCKER_IMAGE}:latest -f Dockerfile .."
                }
                script {
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/stage \
                            -H "Content-Type: application/json" \
                            -d '{"stage_name": "Build", "status": "success"}' || true
                        
                        curl -X POST ${BACKEND_URL}/deployments/event \
                            -H "Content-Type: application/json" \
                            -d '{"event_type": "build", "status": "success", "details": {"image": "${DOCKER_IMAGE}:${BUILD_NUMBER}"}}' || true
                    """
                }
            }
        }

        stage('Push to DockerHub') {
            steps {
                script {
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/stage \
                            -H "Content-Type: application/json" \
                            -d '{"stage_name": "Push", "status": "running"}' || true
                    """
                }
                // Using credential ID: dockerhub (configured in Jenkins)
                withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
                    sh "docker push ${DOCKER_IMAGE}:${BUILD_NUMBER}"
                    sh "docker push ${DOCKER_IMAGE}:latest"
                    sh 'docker logout'
                }
                script {
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/stage \
                            -H "Content-Type: application/json" \
                            -d '{"stage_name": "Push", "status": "success"}' || true
                        
                        curl -X POST ${BACKEND_URL}/deployments/event \
                            -H "Content-Type: application/json" \
                            -d '{"event_type": "push", "status": "success", "details": {"registry": "DockerHub", "image": "${DOCKER_IMAGE}:${BUILD_NUMBER}"}}' || true
                    """
                }
            }
        }

        stage('Deploy to Minikube') {
            steps {
                script {
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/stage \
                            -H "Content-Type: application/json" \
                            -d '{"stage_name": "Deploy", "status": "running"}' || true
                    """
                }
                // Update deployment with new image
                sh """
                    kubectl set image deployment/autodeployx-app \
                        autodeployx-app=${DOCKER_IMAGE}:${BUILD_NUMBER} \
                        --record || kubectl apply -f autodeploy/k8s/deployment.yaml
                """
                sh 'kubectl apply -f autodeploy/k8s/service.yaml'
                sh 'kubectl rollout status deployment/autodeployx-app --timeout=120s'
                
                // Verify pods are running
                sh 'kubectl get pods -l app=autodeployx-app'
                
                script {
                    sh """
                        curl -X POST ${BACKEND_URL}/jenkins/stage \
                            -H "Content-Type: application/json" \
                            -d '{"stage_name": "Deploy", "status": "success"}' || true
                        
                        curl -X POST ${BACKEND_URL}/deployments/event \
                            -H "Content-Type: application/json" \
                            -d '{"event_type": "deploy", "status": "success", "details": {"cluster": "minikube", "namespace": "default", "version": "${BUILD_NUMBER}"}}' || true
                    """
                }
            }
        }

        stage('Smoke Test') {
            steps {
                script {
                    sh """
                        # Get service URL from Minikube
                        SERVICE_URL=\$(minikube service autodeployx-service --url 2>/dev/null || echo "http://localhost:5000")
                        
                        # Test health endpoint
                        curl -f \${SERVICE_URL}/health || echo "Smoke test skipped - service not accessible"
                        
                        echo "‚úÖ Deployment complete!"
                    """
                }
            }
        }
    }

    post {
        success {
            script {
                sh """
                    curl -X POST ${BACKEND_URL}/jenkins/status \
                        -H "Content-Type: application/json" \
                        -d '{"status": "success", "pipeline_name": "AutoDeployX", "build_number": ${BUILD_NUMBER}, "stage": "complete", "message": "Pipeline #${BUILD_NUMBER} completed successfully"}' || true
                """
            }
            echo 'üéâ Pipeline completed successfully!'
        }
        failure {
            script {
                sh """
                    curl -X POST ${BACKEND_URL}/jenkins/status \
                        -H "Content-Type: application/json" \
                        -d '{"status": "failure", "pipeline_name": "AutoDeployX", "build_number": ${BUILD_NUMBER}, "stage": "failed", "message": "Pipeline #${BUILD_NUMBER} failed"}' || true
                """
            }
            echo '‚ùå Pipeline failed!'
        }
        always {
            sh 'docker logout || true'
            cleanWs()
        }
    }
}
